<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0"
		/>
		<title>Pokedex</title>
		<script src="https://cdn.tailwindcss.com"></script>
	</head>
	<body class="bg-gray-100 p-6">
		<h1 class="text-3xl font-bold mb-6 text-center">üêæ My Pok√©dex</h1>
		<div
			id="pokemons"
			class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"
		></div>
		<script>
			function renderPokemons(pokemons) {
				const container = document.getElementById('pokemons');
				container.innerHTML = '';
				pokemons.forEach(p => {
					const div = document.createElement('div');
					div.className = 'bg-white p-4 rounded-xl shadow-md';
					div.innerHTML = `
					<img src="${p.img}" class="mx-auto" />
					<h2 class="text-xl font-bold text-center">${p.name}</h2>
					<p class="text-center text-sm text-gray-500">Level: <span id="level-${
						p.name
					}">${p.level}</span></p>
					<p class="text-center mt-2 text-gray-600">${p.description}</p>
					<div class="mt-2 text-center text-sm">
						<span>Height: ${p.height}</span> |
						<span>Weight: ${p.weight}</span>
					</div>
					${
						p.is_shiny
							? '<p class="text-yellow-500 font-bold text-center mt-2">‚ú® Shiny!</p>'
							: ''
					}
					<div class="flex justify-center gap-2 mt-2">
						<button onclick="deletePokemon('${
							p.name
						}')" class="bg-red-500 text-white px-2 py-1 rounded">Eliminar</button>
						<button onclick="showUpdate('${p.name}', ${
						p.level
					})" class="bg-yellow-500 text-white px-2 py-1 rounded">Actualizar nivel</button>
					</div>
					<div id="update-${
						p.name
					}" style="display:none;" class="mt-2 flex justify-center gap-2">
						<input type="number" id="newlevel-${p.name}" min="1" value="${
						p.level
					}" class="border rounded px-2 py-1 w-20">
						<button onclick="updatePokemon('${
							p.name
						}')" class="bg-green-500 text-white px-2 py-1 rounded">Guardar</button>
					</div>
				`;
					container.appendChild(div);
				});
			}

			function showUpdate(name, level) {
				document.getElementById(`update-${name}`).style.display =
					'flex';
			}

			async function deletePokemon(name) {
				await fetch(`/api/pokemon/${name}`, { method: 'DELETE' });
				// No getPokemons aqu√≠, el polling lo actualiza
			}

			async function updatePokemon(name) {
				const newLevel = document.getElementById(
					`newlevel-${name}`
				).value;
				await fetch('/api/pokemon', {
					method: 'PUT',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ name, level: parseInt(newLevel) })
				});
				// No getPokemons aqu√≠, el polling lo actualiza
			}

			let lastPokemons = null;
			async function getPokemons() {
				const resp = await fetch('/api/pokemons');
				const pokemons = await resp.json();
				// Solo actualiza si hay cambios
				if (
					JSON.stringify(pokemons) !== JSON.stringify(lastPokemons)
				) {
					renderPokemons(pokemons);
					lastPokemons = pokemons;
				}
			}

			// Inicializar y polling
			window.onload = function () {
				getPokemons();
				setInterval(getPokemons, 2000);
			};
		</script>
	</body>
</html>
